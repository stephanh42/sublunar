(function(){function b(d,e,g){function a(j,i){if(!e[j]){if(!d[j]){var f="function"==typeof require&&require;if(!i&&f)return f(j,!0);if(h)return h(j,!0);var c=new Error("Cannot find module '"+j+"'");throw c.code="MODULE_NOT_FOUND",c}var k=e[j]={exports:{}};d[j][0].call(k.exports,function(b){var c=d[j][1][b];return a(c||b)},k,k.exports,b,d,e,g)}return e[j].exports}for(var h="function"==typeof require&&require,c=0;c<g.length;c++)a(g[c]);return a}return b})()({1:[function(a,b,c){"use strict";function d(a,b,c){return(1-a)*b+a*c}const e=a=>a;class f{constructor(a,b,c,d=1){this.time=a,this.x=b,this.y=c,this.opacity=d}interpolate(a,b,c){let e=(b-this.time)/(a.time-this.time);return e=c(Math.max(0,Math.min(1,e))),new f(b,d(e,this.x,a.x),d(e,this.y,a.y),d(e,this.opacity,a.opacity))}}c.lerp=d,c.bump=a=>4*a*(1-a),c.State=f,c.ObjectAnimation=class{constructor(a,b,c,d=e){this.gameObject=a,this.beginState=b,this.endState=c,this.sfunc=d}getState(a){return this.beginState.interpolate(this.endState,a,this.sfunc)}endTime(){return this.endState.time}}},{}],2:[function(a,b){"use strict";class c extends Error{}b.exports=function(a,b="Invalid assertion"){if(!a)throw new c(b)}},{}],3:[function(a,b){"use strict";b.exports=class{constructor(a){this.canvas=a,this.drawPromise=null,this.loadPromise=Promise.resolve().then(()=>this.load()),this.dpi=1}async load(){}redraw(){return null===this.drawPromise&&(this.drawPromise=this.loadPromise.then(()=>new Promise((a,b)=>window.requestAnimationFrame(c=>{this.drawPromise=null;try{this.basicDraw(c),a(c)}catch(a){b(a)}})))),this.drawPromise}async animateUntil(a){for(;;){const b=await this.redraw();if(b>=a)return b}}redrawOnWindowResize(){window.addEventListener("resize",()=>this.redraw(),!1)}basicDraw(a){performance.mark("draw-start");const b=this.canvas,c=0|b.clientWidth*this.dpi,d=0|b.clientHeight*this.dpi;(c!==b.width||d!==b.height)&&(b.width=c,b.height=d),this.draw(a),performance.mark("draw-end"),performance.measure("draw","draw-start","draw-end")}draw(){}getMousePos(a){const b=this.canvas,c=b.getBoundingClientRect();return[(a.clientX-c.left)/(c.right-c.left)*b.width,(a.clientY-c.top)/(c.bottom-c.top)*b.height]}}},{}],4:[function(a,b,c){"use strict";const d=["game","game-objects","terrain","remembered-terrain"];c.objectStores=d,c.openDatabase=function(){return new Promise((a,b)=>{const c=window.indexedDB.open("SublunarGameDB",1);c.onerror=()=>b(c.error),c.onsuccess=b=>a(b.target.result),c.onupgradeneeded=a=>{const b=a.target.result;for(const c of d)b.createObjectStore(c)}})}},{}],5:[function(a,b){"use strict";const c=a("./world.js"),d=a("./pqueue.js"),{getIdFromXY:e}=a("./indexutil.js"),{registerClass:f}=a("./pickle.js"),g=a("./assert.js");class h{constructor(){this.flags=0,this.x=0,this.y=0}getFlag(a){return(this.flags&a)===a}setFlag(a,b){this.flags=b?this.flags|a:this.flags&~a}get isPlaced(){return this.getFlag(1)}set isPlaced(a){this.setFlag(1,a)}pickleData(){const a={};return this.flags&&(a.flags=this.flags),a}unpickleData(a){this.flags=a.flags||0}markDirty(){this.isPlaced&&c.dirtyGameObjects.add(e(this.x,this.y))}basicMove(a,b){this.isPlaced&&(this.markDirty(),c.deleteGameObject(this.x,this.y,this)),this.x=a,this.y=b,this.isPlaced=!0,c.setGameObject(a,b,this),this.markDirty(),this===c.player&&c.updateVisible()}updateSeen(){}schedule(a,b){const e=c.scheduleOrder;c.scheduleOrder=e+1,d.insert(c.schedule,{time:c.time+a,order:e,object:this,action:b})}getReference(){if(this.isPlaced){const a=c.getGameObjects(this.x,this.y).indexOf(this);return g(0<=a),Int32Array.of(this.x,this.y,a)}return null}}h.prototype.passable=!0,h.prototype.isMonster=!1,f(h,10),b.exports=h},{"./assert.js":2,"./indexutil.js":9,"./pickle.js":15,"./pqueue.js":16,"./world.js":21}],6:[function(a,b){"use strict";var c=Math.abs,d=Math.floor,e=Math.round,f=Math.max,g=Math.min;const h=a("./canvasviewer.js"),i=a("./terrain.js"),j=a("./monster.js"),k=a("./database.js"),l=a("./world.js"),m=a("./newgame.js"),n={h:[-1,0],j:[0,1],k:[0,-1],l:[1,0],ArrowLeft:[-1,0],ArrowRight:[1,0],ArrowUp:[0,-1],ArrowDown:[0,1],Left:[-1,0],Right:[1,0],Up:[0,-1],Down:[0,1],b:[-1,1],n:[1,1],y:[-1,-1],u:[1,-1],1:[-1,-1],2:[0,-1],3:[1,-1],4:[-1,0],6:[1,0],7:[-1,1],8:[0,1],9:[1,1]};class o{constructor(a,b,c){this.message=a,this.color=b,this.repeat=1,this.hp=c}makeElement(){const a=document.createElement("span");if(a.className="message-span",a.style.color=this.color,a.appendChild(document.createTextNode(this.message)),1<this.repeat){const b=document.createElement("span");b.style.color="white",b.appendChild(document.createTextNode(` [${this.repeat}x]`)),a.appendChild(b)}if(0!==this.hp){const b=document.createElement("span");b.style.color="yellow",b.appendChild(document.createTextNode(` (${this.hp} HP)`)),a.appendChild(b)}return a}tryCombine(a){return!!a&&!(this.message!==a.message||this.color!==a.color)&&(this.repeat+=a.repeat,this.hp+=a.hp,!0)}}class p{constructor(a,b){this.gameViewer=a,this.messageArea=b,this.lastMessage=null}redraw(){return this.gameViewer.redraw()}async animate(a){const b=this.gameViewer;b.animation=a;const c=await b.animateUntil(a.endTime());return b.animation=null,c}now(){return performance.now()}message(a,b="white",c=0){const d=new o(a,b,c);d.tryCombine(this.lastMessage)&&this.messageArea.removeChild(this.messageArea.lastChild),this.messageArea.appendChild(d.makeElement()),this.lastMessage=d}clearMessageArea(){for(let a;a=this.messageArea.lastChild;)this.messageArea.removeChild(a);this.lastMessage=null}}b.exports=class extends h{constructor(a,b){super(a),this.blocked=!1,this.animation=null;const c=f(1,g(2,window.devicePixelRatio||1));this.dpi=c,this.tileSize=8*e(5*c),this.ui=l.ui=new p(this,b),document.addEventListener("keydown",a=>this.onkeydown(a),!1),a.addEventListener("click",a=>this.onclick(a),!1)}async handlePromise(a){this.blocked=!0;try{await a,await l.runSchedule(),performance.mark("saveGame-start"),await l.saveGame(),performance.mark("saveGame-end"),performance.measure("saveGame","saveGame-start","saveGame-end")}catch(a){console.error(a)}finally{this.blocked=!1,this.redraw()}}onkeydown(a){const b=n[a.key];if(b){const[a,c]=b;this.playerMove(a,c)}else"+"===a.key?(this.tileSize=g(96,this.tileSize+8),this.redraw()):"-"===a.key&&(this.tileSize=f(32,this.tileSize-8),this.redraw())}onclick(a){const[b,e]=this.getMousePos(a),f=this.tileSize,g=f+2,h=this.canvas,i=h.width-g>>1,j=h.height-g>>1,k=d((b-i)/g),l=d((e-j)/g);1>=c(k)&&1>=c(l)&&(0!==k||0!==l)&&this.playerMove(k,l)}playerMove(a,b){if(!this.blocked)return this.ui.clearMessageArea(),this.handlePromise(l.tryPlayerMove(a,b))}async load(){const a=k.openDatabase(),b=i.loadImages(),c=j.loadImages();l.database=await a;let d;(await l.tryLoadGame())?d="Game restored.":(d="Starting a new game.",m(),await l.saveGame({clearAll:!0})),await b,await c,this.ui.clearMessageArea(),this.ui.message(d,"yellow")}draw(a){var b=Math.ceil;const c=this.canvas,f=c.getContext("2d"),g=c.width,h=c.height;f.clearRect(0,0,g,h);const i=l.player;if(!i||!i.isPlaced)return;const j=this.animation,k=i.x,m=i.y,n=this.tileSize,o=n+2;let p=g-o>>1,q=h-o>>1;const r=j&&j.gameObject;if(r===i){const b=j.getState(a);p-=e((b.x-k)*o),q-=e((b.y-m)*o)}f.save(),f.translate(p,q),f.fillStyle="rgba(0, 0, 0, 0.5)";for(let c=d(-q/o);c<b((h-q)/o);c++)for(let a=d(-p/o);a<b((g-p)/o);a++){const b=a+k,d=c+m,e=l.isVisible(b,d);let g=!1;const h=l.getRememberedTerrain(b,d),i=h.images;if(i&&(f.drawImage(i.get(n),a*o,c*o),g=!0),e)for(const e of l.getGameObjects(b,d))e!==r&&e.draw(f,a*o,c*o,n);!e&&g&&f.fillRect(a*o,c*o,n,n)}if(r){const b=j.getState(a),c=e((b.x-k)*o),d=e((b.y-m)*o),g=b.opacity;1===g?r.draw(f,c,d,n):0<g&&(f.globalAlpha=g,r.draw(f,c,d,n),f.globalAlpha=1)}this.blocked||(f.strokeStyle="#FFFFFF",f.setLineDash([4,4]),f.beginPath(),f.rect(-.5,-.5,n+1,n+1),f.stroke()),f.restore()}}},{"./canvasviewer.js":3,"./database.js":4,"./monster.js":10,"./newgame.js":12,"./terrain.js":18,"./world.js":21}],7:[function(a,b,c){"use strict";function d(a){return new Promise((b,c)=>{const d=new Image;d.onload=()=>b(d),d.onerror=()=>c(new Error(`Cannot load image: ${a}`)),d.src=a})}function e(a,b){const c=document.createElement("canvas");return c.width=a,c.height=b,c}function f(a,b,c){if(b===c)return a;const d=e(c,c),f=d.getContext("2d"),g=c/b;return f.scale(g,g),f.drawImage(a,0,0),d}class g{constructor(a,b){this.im1=a,this.im2=b,this.cachedImage=null,this.cachedImageSize=-1}getUncached(a){return a<=this.im1.width?f(this.im1,this.im1.width,a):f(this.im2,this.im2.width,a)}get(a){return this.cachedImageSize!==a&&(this.cachedImage=this.getUncached(a),this.cachedImageSize=a),this.cachedImage}}c.loadImage=d,c.loadImageSizes=async function(a){const b=d(a+".png"),c=d(a+"@2.png");return new g((await b),(await c))}},{}],8:[function(a){"use strict";const b=a("./gameviewer.js"),c=document.getElementById("theCanvas"),d=document.getElementById("messageArea"),e=new b(c,d);e.redrawOnWindowResize(),e.redraw().then(console.log,console.error)},{"./gameviewer.js":6}],9:[function(a,b,c){"use strict";c.getIdFromXY=(a,b)=>a<<16|b&65535,c.getXFromId=a=>a>>16,c.getYFromId=a=>a<<16>>16},{}],10:[function(a,b){"use strict";function c(a,b,c,d,e){1===e?a.drawImage(b,c,d):(a.save(),a.translate(c+b.width,d),a.scale(-1,1),a.drawImage(b,0,0),a.restore())}const{loadImageSizes:d}=a("./imgutil.js"),{awaitPromises:e}=a("./terrain.js"),{registerClass:f}=a("./pickle.js"),{randomInt:g}=a("./randutil.js"),h=a("./game-object.js"),i=a("./world.js"),j=a("./animation.js"),k=a("./path-finder.js"),{toTitleCase:l}=a("./textutil.js"),m=a("./assert.js"),n={},o=[],p=Promise.resolve();class q{constructor(a,b){this.id=a,this.name=b.name,this.imageName=b.image||b.name,this.baseDelay=b.baseDelay||6,this.intelligence=b.intelligence||10,this.images=null}}for(const c of a("./monstertype.js")){const a=new q(o.length,c);o.push(a),n[a.name]=a}class r extends k{constructor(a,b,c,d,e){super(a,b,c,d),this.monster=e}isPassable(a,b){return this.monster.isPassable(a,b)}}class s extends h{constructor(a){super(),this.monsterType=a,this.direction=2*g(2)-1}get waiting(){return this.getFlag(2)}set waiting(a){this.setFlag(2,a)}pickleData(){const a=super.pickleData();return a.mt=this.monsterType.id,a.dir=this.direction,a}unpickleData(a){super.unpickleData(a),this.monsterType=o[a.mt],this.direction=a.dir}theName(){const a=this.monsterType.name;return this.isPlayer()?"your "+a:"the "+a}draw(a,b,d,e){const f=this.monsterType.images.get(e);c(a,f,b,d,this.direction)}sleep(a){this.waiting=!0,this.schedule(a,"wakeUp")}updateSeen(){this.waiting||this.isPlayer()||this.sleep(0)}setDirection(a){0!==a&&(this.direction=a)}doMove(a,b){m(!this.waiting);const c=this.x,d=this.y,e=c+a,f=d+b,g=i.isVisible(c,d);this.basicMove(e,f),this.sleep(this.monsterType.baseDelay);const h=i.isVisible(e,f);if(this.setDirection(a),g||h){const a=i.ui.now();return i.ui.animate(new j.ObjectAnimation(this,new j.State(a,c,d,0|g),new j.State(a+100,e,f,0|h)))}return p}doAttack(a){m(!this.waiting);const b=i.isVisible(this.x,this.y),c=i.isVisible(a.x,a.y),d=4+g(6);if(this.setDirection(a.x-this.x),this.sleep(this.monsterType.baseDelay),b||c){const e=i.ui.now();return i.ui.message(`${l(this.theName())} attacks ${a.theName()}.`,this.isPlayer()?"chartreuse":"red",d),i.ui.animate(new j.ObjectAnimation(this,new j.State(e,this.x,this.y,0|b),new j.State(e+100,a.x,a.y,0|c),j.bump))}return p}isPlayer(){return this===i.player}isPassable(a,b){return i.isPassable(a,b)}target(){const a=i.player;return a.isPlaced?a:null}async wakeUp(){if(this.waiting=!1,!this.isPlayer()){const a=this.target();if(a){const b=new r(this.x,this.y,a.x,a.y,this);b.runN(this.monsterType.intelligence);const c=b.getPath();if(2<=c.length){const[b,d]=c[1];if(this.isPassable(b,d))return this.doMove(b-this.x,d-this.y);if(i.getGameObjects(b,d).includes(a))return this.doAttack(a)}}}}static loadImages(){const a=[];for(const b of o)b.imageName&&a.push(d("img/"+b.imageName).then(a=>{b.images=a}));return e(a)}}s.monsterTypes=n,s.monsterList=o,s.prototype.passable=!1,s.prototype.isMonster=!0,f(s,20),b.exports=s},{"./animation.js":1,"./assert.js":2,"./game-object.js":5,"./imgutil.js":7,"./monstertype.js":11,"./path-finder.js":13,"./pickle.js":15,"./randutil.js":17,"./terrain.js":18,"./textutil.js":20,"./world.js":21}],11:[function(a,b){"use strict";b.exports=[{name:"submarine"},{name:"squid",baseDelay:12}]},{}],12:[function(a,b){"use strict";function c(a){let b=0,c=0;for(let h=0;h<a;h++)for(0===c?(f.setTerrain(b,0,d.wave),f.setTerrain(b,-1,d.air)):(f.setTerrain(b,c,d.water),f.isPassable(b,c)&&.01>Math.random()&&new e(e.monsterTypes.squid).basicMove(b,c));;){const[a,d]=g(b,c);if(0<=d&&10>d){b=a,c=d;break}}}const{terrainTypes:d}=a("./terrain.js"),e=a("./monster.js"),f=a("./world.js"),{randomStep:g}=a("./randutil.js");b.exports=function(){f.reset(),c(1e3);const a=new e(e.monsterTypes.submarine);return f.player=a,a.basicMove(0,0),f}},{"./monster.js":10,"./randutil.js":17,"./terrain.js":18,"./world.js":21}],13:[function(a,b){"use strict";var c=Math.abs;const d=a("./pqueue.js"),{getIdFromXY:e}=a("./indexutil.js");class f{constructor(a,b,c,d,e,f){this.time=a+b,this.cost=b,this.order=c,this.x=d,this.y=e,this.previous=f}}b.exports=class{constructor(a,b,c,d){this.incomplete=!0,this.found=!1,this.currentNode=null,this.x1=c,this.y1=d,this.closedSet=new Set,this.openSet=[],this.addOpenSet(0,a,b,null)}cost(){return 1}isPassable(){return!0}isPassableOrDestination(a,b){return a===this.x1&&b===this.y1||this.isPassable(a,b)}addOpenSet(a,b,e,g=null){const h=b-this.x1,i=e-this.y1,j=Math.max(c(h),c(i));d.insert(this.openSet,new f(j,a,h*h+i*i,b,e,g))}runStep(){if(0===this.openSet.length)return this.incomplete=!1,void(this.found||(this.currentNode=null));const a=d.remove(this.openSet),b=a.x,c=a.y,f=e(b,c);if(!this.closedSet.has(f)){if(this.currentNode=a,b===this.x1&&c===this.y1)return this.openSet=[],this.incomplete=!1,void(this.found=!0);this.closedSet.add(f);for(let d=-1;1>=d;d++)for(let f=-1;1>=f;f++){if(0==d&&0==f)continue;const g=b+d,h=c+f,i=e(g,h);if(this.closedSet.has(i)||!this.isPassableOrDestination(g,h))continue;const j=a.cost+this.cost(g,h);this.addOpenSet(j,g,h,a)}}}run(){for(;this.incomplete;)this.runStep()}runN(a){for(;this.incomplete&&0<a;)this.runStep(),a--}getPath(){const a=[];for(let b=this.currentNode;b;)a.push([b.x,b.y]),b=b.previous;return a.reverse(),a}}},{"./indexutil.js":9,"./pqueue.js":16}],14:[function(a,b,c){"use strict";function d(a,b,c,d){const e=b-d;return c*(b/e)-a*(d/e)}class e{constructor(c,a){this.a=c,this.b=a}atPoint(a,b){return this.a*a+this.b-b}zeroCrossing(a,b,c){return new e(d(this.a,a,b.a,c),d(this.b,a,b.b,c))}}class f{constructor(a){this.rays=a}isEmpty(){return 0===this.rays.length}splitPoint(a,b){const c=[],d=[],e=[];let g=!1,h=!1,i=null,j=0;3<=this.rays.length&&(i=this.rays[this.rays.length-1],j=i.atPoint(a,b));for(const f of this.rays){const k=f.atPoint(a,b);if(i&&(0>j&&0<k||0<j&&0>k)){const a=i.zeroCrossing(j,f,k);c.push(a),d.push(a),e.push(a)}0>k?(c.push(f),g=!0):0<k?(e.push(f),h=!0):(c.push(f),d.push(f),e.push(f)),i=f,j=k}return{negative:new f(g?c:[]),zero:new f(d),positive:new f(h?e:[])}}}const g=new f([new e(0,.5),new e(0,-.5),new e(1,-1),new e(1,1)],!0);class h{constructor(a,b,c){this.x=a,this.y=b,this.distance=Math.hypot(a,b),this._beam=c,this._children=null}_addChild(a,b,c){c.isEmpty()||this._children.push(new h(this.x+a,this.y+b,c))}children(){if(!this._children){this._children=[];const a=this.x,b=this.y,c=this._beam.splitPoint(a+.5,b+.5);this._addChild(0,1,c.positive.splitPoint(a-.5,b+.5).negative),this._addChild(1,1,c.zero),this._addChild(1,0,c.negative.splitPoint(a+.5,b-.5).positive)}return this._children}}const i=new h(0,0,g);c.fovTree=i},{}],15:[function(a,b,c){"use strict";const d=a("./assert.js"),e=Symbol(),f=new Map;c.registerClass=function(a,b){d(f.get(b)===void 0,"Class ID already in use");const c=a.prototype;d(c.pickleData,"Class misses pickleData method"),d(c.unpickleData,"Class misses unpickleData method"),f.set(b,a),c[e]=b},c.pickle=function(a){const b=a.pickleData();return b["class"]=a[e],b},c.unpickle=function(a){const b=f.get(a["class"]),c=new b;return c.unpickleData(a),c}},{"./assert.js":2}],16:[function(a,b,c){"use strict";function d(a,b,c){const d=a[b];a[b]=a[c],a[c]=d}function e(a,b){const c=a.time,d=b.time;return c<d||c===d&&a.order<b.order}function f(a,b){let c=a.length;for(a.push(b);0<c;){const f=c-1>>1,g=a[f];if(e(b,g))d(a,c,f),c=f;else break}}function g(a){if(0===a.length)return;if(1===a.length)return a.pop();const b=a[0];a[0]=a.pop();let c=0;for(const b=a[c];;){const f=2*c+1,g=2*c+2;if(f>=a.length)break;else if(g>=a.length){e(a[f],b)&&d(a,c,f);break}else{const h=a[f],i=a[g];if(!e(h,b)&&!e(i,b))break;else e(h,i)?(d(a,c,f),c=f):(d(a,c,g),c=g)}}return b}c.insert=f,c.remove=g,c.test=function(a=10){const b=[],c=[];for(let d=0;d<a;d++){const a={time:Math.random(),order:d};f(c,a),b.push(a)}const d=[];for(;0<c.length;)d.push(g(c));return[b,d]}},{}],17:[function(a,b,c){"use strict";function d(a){return 0|Math.random()*a}c.randomInt=d,c.randomStep=function(a=0,b=0){switch(d(4)){case 0:a++;break;case 1:b++;break;case 2:a--;break;case 3:b--;}return[a,b]},c.randomRange=function(a,b){const c=b-a,e=c>>1;return a+d(e+1)+d(c-e+1)}},{}],18:[function(a,b,c){"use strict";async function d(a){for(const b of a)await b}const{loadImageSizes:e}=a("./imgutil.js");class f{constructor(a,b){this.id=a,this.name=b.name,this.transparent=b.transparent,this.passable=b.passable,this.imageName=b.image,this.images=null}}const g={},h=[];for(const d of a("./terraintype.js")){const a=new f(h.length,d);h.push(a),g[a.name]=a}c.terrainTypes=g,c.terrainList=h,c.loadImages=function(){const a=[];for(const b of h)b.imageName&&a.push(e("img/"+b.imageName).then(a=>{b.images=a}));return d(a)},c.awaitPromises=d},{"./imgutil.js":7,"./terraintype.js":19}],19:[function(a,b){"use strict";b.exports=[{name:"unseen",passable:!1,transparent:!1},{name:"wall",image:"wall",passable:!1,transparent:!1},{name:"water",image:"water",passable:!0,transparent:!0},{name:"wave",image:"wave",passable:!0,transparent:!0},{name:"air",passable:!1,transparent:!0}]},{}],20:[function(a,b,c){"use strict";c.toTitleCase=function(a){return""===a?a:a[0].toUpperCase()+a.slice(1)}},{}],21:[function(a,b){"use strict";function c(a,b){return(15&b)<<4|15&a}function d(a){return a?a.getReference():null}function e(a){return a=Object.assign({},a),a.object=d(a.object),a}function f(a,b,c){return c=o(c),c.x=a,c.y=b,c}const g=a("./permissive-fov.js"),h=g.fovTree.children(),i=a("./pqueue.js"),j=a("./database.js"),{getIdFromXY:k,getXFromId:l,getYFromId:m}=a("./indexutil.js"),{pickle:n,unpickle:o}=a("./pickle.js"),p=a("./assert.js"),{terrainTypes:q,terrainList:r}=a("./terrain.js");class s{constructor(a){this.defaultTerrain=a,this.terrainMap=new Map,this.dirty=new Set}get(a,b){const d=k(a,b),e=this.terrainMap.get(d);return e?r[e[c(a,b)]]:this.defaultTerrain}set(a,b,d){const e=k(a,b);this.dirty.add(e);let f=this.terrainMap.get(e);f||(f=new Uint8Array(256),f.fill(this.defaultTerrain.id),this.terrainMap.set(e,f)),f[c(a,b)]=d.id}markNonDirty(){this.dirty.clear()}saveDirty(a){for(const b of this.dirty)a.put(this.terrainMap.get(b),b)}load(a){a.openCursor().onsuccess=a=>{const b=a.target.result;b&&(this.terrainMap.set(b.key,b.value),b.continue())}}}const t=Promise.resolve();class u{redraw(){return t}animate(){return t}now(){return 0}}const v=[],w=2;b.exports=new class{constructor(){this.terrainGrid=null,this.rememberedTerrainGrid=null,this.gameObjects=null,this.dirtyGameObjects=null,this.player=null,this.visible=null,this.time=0,this.scheduleOrder=0,this.schedule=[],this.ui=new u,this.database=null}reset(){this.terrainGrid=new s(q.wall),this.rememberedTerrainGrid=new s(q.unseen),this.gameObjects=new Map,this.dirtyGameObjects=new Set,this.visible=new Set,this.time=0,this.scheduleOrder=0,this.schedule=[],this.player=null}getTerrain(a,b){return this.terrainGrid.get(a,b)}setTerrain(a,b,c){return this.terrainGrid.set(a,b,c)}getRememberedTerrain(a,b){return this.rememberedTerrainGrid.get(a,b)}updateSeen(a,b){this.rememberedTerrainGrid.set(a,b,this.terrainGrid.get(a,b));for(const c of this.getGameObjects(a,b))c.updateSeen()}updateVisible(){function a(c,h){for(const i of c){if(i.distance>f)continue;let c=i.x,j=i.y;if(1&h&&(c=-c),2&h&&(j=-j),4&h){const a=c;c=j,j=a}c+=d,j+=e,b.add(k(c,j)),g.updateSeen(c,j),g.getTerrain(c,j).transparent&&a(i.children(),h)}}const b=new Set;this.visible=b;const c=this.player;if(!c)return;const d=c.x,e=c.y,f=7,g=this;b.add(k(d,e)),g.updateSeen(d,e);for(let b=0;8>b;b++)a(h,b)}isVisible(a,b){return this.visible.has(k(a,b))}setGameObject(a,b,c){const d=k(a,b),e=this.gameObjects.get(d);e?e.push(c):this.gameObjects.set(d,[c])}deleteGameObject(a,b,c){const d=k(a,b),e=this.gameObjects.get(d);if(1===e.length)p(e[0]===c),this.gameObjects.delete(d);else{const a=e.indexOf(c);p(0<=a),e.splice(a,1)}}getGameObjects(a,b){return this.gameObjects.get(k(a,b))||v}getMonster(a,b){for(const c of this.getGameObjects(a,b))if(c.isMonster)return c}isPassable(a,b){if(!this.getTerrain(a,b).passable)return!1;for(const c of this.getGameObjects(a,b))if(!c.passable)return!1;return!0}tryPlayerMove(a,b){const c=this.player;if(!c)return t;const d=a+c.x,e=b+c.y;if(this.isPassable(d,e))return c.doMove(a,b);else{const a=this.getMonster(d,e);return a?c.doAttack(a):t}}async runSchedule(){const a=this.player,b=this.schedule;for(;a.waiting;){const a=i.remove(b);p(a),this.time=a.time;const c=a.object;c&&c.isPlaced&&(await c[a.action].call(c))}}resolveReference(a){return a?this.getGameObjects(a[0],a[1])[a[2]]:null}unpickleAction(a){return a=Object.assign({},a),a.object=this.resolveReference(a.object),a}getGlobalData(){return{version:w,visible:this.visible,time:this.time,scheduleOrder:this.scheduleOrder,schedule:this.schedule.map(e),player:d(this.player)}}setGlobalData(a){this.visible=a.visible,this.time=a.time,this.scheduleOrder=a.scheduleOrder,this.schedule=a.schedule.map(a=>this.unpickleAction(a)),this.player=this.resolveReference(a.player)}saveGame({clearAll:a=!1}={}){return new Promise((b,c)=>{const d=this.database.transaction(j.objectStores,"readwrite");if(d.onerror=()=>c(d.error),d.onabort=()=>c(new Error("Transaction aborted")),d.oncomplete=()=>{this.markNonDirty(),b()},a)for(const a of j.objectStores)d.objectStore(a).clear();d.objectStore("game").put(this.getGlobalData(),1);const e=d.objectStore("game-objects");for(const a of this.dirtyGameObjects){const b=this.gameObjects.get(a);b?e.put(b.map(n),a):e.delete(a)}this.terrainGrid.saveDirty(d.objectStore("terrain")),this.rememberedTerrainGrid.saveDirty(d.objectStore("remembered-terrain"))})}tryLoadGame(){return new Promise((a,b)=>{this.reset();const c=this.database.transaction(j.objectStores,"readonly");c.onerror=()=>{c.error?b(c.error):a(!1)},c.onabort=()=>a(!1),c.oncomplete=()=>a(!0),this.terrainGrid.load(c.objectStore("terrain")),this.rememberedTerrainGrid.load(c.objectStore("remembered-terrain")),c.objectStore("game-objects").openCursor().onsuccess=a=>{const b=a.target.result;if(b){const a=b.key,c=l(a),d=m(a),e=b.value.map(a=>f(c,d,a));this.gameObjects.set(a,e),b.continue()}else c.objectStore("game").get(1).onsuccess=a=>{const b=a.target.result;b&&b.version===w?this.setGlobalData(b):c.abort()}}})}markNonDirty(){this.dirtyGameObjects.clear(),this.terrainGrid.markNonDirty(),this.rememberedTerrainGrid.markNonDirty()}}},{"./assert.js":2,"./database.js":4,"./indexutil.js":9,"./permissive-fov.js":14,"./pickle.js":15,"./pqueue.js":16,"./terrain.js":18}]},{},[8]);